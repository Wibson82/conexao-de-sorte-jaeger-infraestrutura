name: "üìä Jaeger Infrastructure ‚Äì CI/CD Pipeline"

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  SERVICE_NAME: jaeger-infrastructure

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validate-and-build:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4.3.0

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 python3-yaml

      - name: Validate Docker Compose
        run: |
          # Validar sintaxe do docker-compose.yml
          docker compose -f docker-compose.yml config -q
          echo "‚úÖ Docker Compose syntax is valid"

      - name: Security Validation
        run: |
          # Verificar se n√£o h√° hardcoded passwords
          if grep -r "password.*:" docker-compose.yml | grep -v "\${" | grep -v "#" | grep -v "external:"; then
            echo "‚ùå Found potential hardcoded passwords"
            exit 1
          else
            echo "‚úÖ No hardcoded passwords found"
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4.5.0
        with:
          name: jaeger-configs
          path: |
            docker-compose.yml

  deploy-selfhosted:
    needs: validate-and-build
    runs-on: [ self-hosted, Linux, X64, conexao, conexao-de-sorte-jaeger-infraestrutura ]
    timeout-minutes: 15
    if: github.ref == 'refs/heads/main'
    env:
      DOCKER_NETWORK_NAME: conexao-network-swarm
      STACK_NAME: conexao-jaeger
      COMPOSE_FILE: docker-compose.yml
    steps:
      - uses: actions/checkout@v4.3.0
        with:
          clean: true
          fetch-depth: 1

      - name: Download artifacts
        uses: actions/download-artifact@v4.1.8
        with:
          name: jaeger-configs
          path: .

      - name: üöÄ Deploy Jaeger Stack (Swarm-Only)
        env:
          STACK_NAME: conexao-jaeger
          COMPOSE_FILE: docker-compose.yml
        run: |
          echo "üöÄ Iniciando deploy do Jaeger com Docker Swarm..."

          # Remover stack existente se houver
          if docker stack ls | grep -q "$STACK_NAME"; then
            echo "üîÑ Removendo stack existente '$STACK_NAME'..."
            docker stack rm "$STACK_NAME"
            sleep 10
          fi

          # Deploy da nova stack
          echo "üèóÔ∏è Executando deploy da stack '$STACK_NAME'..."
          docker stack deploy -c "$COMPOSE_FILE" "$STACK_NAME"

          echo "‚è∞ Aguardando estabiliza√ß√£o dos servi√ßos Jaeger..."
          sleep 45  # Jaeger precisa de tempo para inicializar

      - name: Healthcheck Jaeger
        env:
          STACK_NAME: conexao-jaeger
        run: |
          echo "üîç Validando sa√∫de do Jaeger..."

          # Aguardar at√© 4 minutos para Jaeger ficar dispon√≠vel
          timeout=240
          elapsed=0

          while [ $elapsed -lt $timeout ]; do
            JAEGER_CONTAINER=$(docker ps -q -f name="${STACK_NAME}_jaeger" | head -1)

            if [ -n "$JAEGER_CONTAINER" ]; then
              # Testar se Jaeger UI responde
              if docker exec "$JAEGER_CONTAINER" wget --quiet --tries=1 --timeout=5 --spider http://localhost:16686 2>/dev/null; then
                echo "‚úÖ Jaeger health check passed"
                break
              else
                echo "‚è≥ Jaeger ainda n√£o est√° pronto... ($elapsed/$timeout segundos)"
                sleep 15
                elapsed=$((elapsed + 15))
              fi
            else
              echo "‚è≥ Container Jaeger ainda n√£o encontrado... ($elapsed/$timeout segundos)"
              sleep 15
              elapsed=$((elapsed + 15))
            fi
          done

          if [ $elapsed -ge $timeout ]; then
            echo "‚ùå Jaeger health check failed - timeout ap√≥s $timeout segundos"
            echo "üîç Verificando logs do Jaeger..."
            if [ -n "$JAEGER_CONTAINER" ]; then
              docker logs "$JAEGER_CONTAINER" --tail 20 2>/dev/null || true
            fi
            exit 1
          fi

      - name: Connectivity Validation
        env:
          STACK_NAME: conexao-jaeger
        run: |
          echo "üîó Validando conectividade do Jaeger..."

          # Verificar se o servi√ßo est√° listado no Swarm
          if docker service ls | grep -q "${STACK_NAME}_jaeger"; then
            echo "‚úÖ Servi√ßo Jaeger encontrado no Swarm"
          else
            echo "‚ùå Servi√ßo Jaeger n√£o encontrado no Swarm"
            exit 1
          fi

          # Verificar se est√° na rede correta
          if docker network inspect conexao-network-swarm | grep -q jaeger; then
            echo "‚úÖ Jaeger conectado √† rede overlay"
          else
            echo "‚ö†Ô∏è Jaeger pode n√£o estar na rede overlay correta"
          fi

          # Testar endpoints adicionais
          JAEGER_CONTAINER=$(docker ps -q -f name="${STACK_NAME}_jaeger" | head -1)
          if [ -n "$JAEGER_CONTAINER" ]; then
            # Testar endpoint Zipkin compat√≠vel
            if docker exec "$JAEGER_CONTAINER" wget --quiet --tries=1 --timeout=3 --spider http://localhost:9411 2>/dev/null; then
              echo "‚úÖ Jaeger Zipkin endpoint ativo"
            else
              echo "‚ö†Ô∏è Jaeger Zipkin endpoint pode n√£o estar ativo"
            fi
          fi

          echo "üìä Status final dos servi√ßos:"
          docker service ls --filter name="${STACK_NAME}_*" --format "table {{.Name}}\t{{.Replicas}}\t{{.Image}}"